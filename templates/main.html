<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>MRI Viewer</title>
</head>
<body>
    MRI Viewer
    <div>
        <div>
            <label for="scan_type">Scan Type</label>
            <select id="scan_type">
                <option value="flair">Flair</option>
                <option value="t1">T1</option>
                <option value="t1c">T1c</option>
                <option value="t2">T2</option>
            </select>
            <a href='/download' target="blank"><input type="button" value="Download nii.gz. tumor file"/></a>
        </div>
        <div>
            <canvas id="ax_b"></canvas>
            <canvas id="ax_t"></canvas>
            <input type="range" id="ax_range"/>
            <input type="text" id="ax_index"/>
        </div>
        <div>
            <div>
                <canvas id="sg_b"></canvas>
                <canvas id="sg_t"></canvas>
                <input type="range" id="sg_range"/>
                <input type="text" id="sg_index"/>
            </div>
            <div>
                <canvas id="cr_b"></canvas>
                <canvas id="cr_t"></canvas>
                <input type="range" id="cr_range"/>
                <input type="text" id="cr_index"/>
            </div>
        </div>
        
    </div>
    <script>

        var mri_images
        var scan_types = {
            flair: 0,
            t1: 1,
            t1c: 2,
            t2: 3
        }
        current_scan = 'flair'

        let view = {
            ax: {
                view: 'top',
                brain: document.getElementById('ax_b'),
                tumor: document.getElementById('ax_t'),
                range: document.getElementById('ax_range'),
                index: document.getElementById('ax_index')
            },
            sg: {
                view: 'side',
                brain: document.getElementById('sg_b'),
                tumor: document.getElementById('sg_t'),
                range: document.getElementById('sg_range'),
                index: document.getElementById('sg_index')
            },
            cr: {
                view: 'front',
                brain: document.getElementById('cr_b'),
                tumor: document.getElementById('cr_t'),
                range: document.getElementById('cr_range'),
                index: document.getElementById('cr_index')
            }
        }
        
        function initView() {

            var scan_type = document.getElementById('scan_type');
            var download = document.getElementById('download');

            scan_type.selectedIndex = scan_types[current_scan]

            for (var key in view) {
                view[key].brain.draw = draw;
                view[key].tumor.draw = draw;
            }

            scan_type.addEventListener('change', function(event) {
                mri_images.current.data = mri_images.scans[this.value];
                drawImages();
            })
        }
        
        function main() {
            
            initView();

            // postRequest('/getResults').then(response => response.json())
            // .then(data => {
            //     initMRIImages(data)
            //     drawImages()
            // }).catch(err => console.log(err))
            
            console.log( {{ data.some }} )
            let data = {
                brain :{
                    flair: {{ data.brain.flair }},
                    t1: {{ data.brain.t1}},
                    t1c: {{ data.brain.t1c }},
                    t2: {{ data.brain.t2 }}
                },
                tumor: {{ data.tumor }}
                
            }

            initMRIImages(data);
            drawImages();

        }

        function initMRIImages(data) {


            mri_images = {
                scans: data.brain,
                current: {
                    data: data.brain[current_scan],
                    getSlice: getSlice,
                    dim: {
                        depth: data.brain[current_scan].length,
                        height:data.brain[current_scan][0].length,
                        width: data.brain[current_scan][0][0].length
                    }
                },
                tumor: {
                    data: data.tumor,
                    getSlice: getSlice,
                    dim: { 
                        depth: data.tumor.length,
                        height:data.tumor[0].length,
                        width: data.tumor[0][0].length
                    }
                }
            }

            // initialize index values and set default  
            half_depth = Math.floor(data.brain[current_scan].length / 2);
            half_width = Math.floor(data.brain[current_scan][0][0].length / 2);
            half_height = Math.floor(data.brain[current_scan][0].length / 2);
            
            view.ax.range.max = mri_images.current.dim.depth;
            view.sg.range.max = mri_images.current.dim.width;
            view.cr.range.max = mri_images.current.dim.height

            view.ax.range.value = half_depth;
            view.sg.range.value = half_width;
            view.cr.range.value = half_height;

            view.ax.range.value = half_depth;
            view.sg.range.value = half_width;
            view.cr.range.value = half_height;

            for (let key in view){
                let v = view[key]
                v.index.value = v.range.value; 
                v.range.addEventListener('change', function(event) {
                    v.index.value = v.range.value;
                    v.brain.draw(mri_images.current.getSlice(v.view,v.range.value), 
                        'grayscale', v.view==='side' || v.view==='front', v.view==='side')
                    v.tumor.draw(mri_images.tumor.getSlice(v.view,v.range.value), 
                        'grayscale', v.view==='side' || v.view==='front', v.view==='side') 
                })
            }
            
        } 

        function drawImages() {
            for (var key in view) {
                let v = view[key]
                
                index = v.range.value
                v.brain.draw(mri_images.current.getSlice(v.view,index),'grayscale',
                    v.view==='side' || v.view==='front', v.view==='side');
                v.tumor.draw(mri_images.tumor.getSlice(v.view,index),'grayscale',
                    v.view==='side' || v.view==='front', v.view==='side');
            }
        }

        function getSlice(type="top", index) {

            if(type === 'top') {
                if(index >= this.data.length) {
                    index = this.data.length - 1;
                }

                if(index < 0) {
                    index = 0
                }
                
                return this.data[index]
            } 
            else if(type === 'side')
            {
                result = [];
                
                // check out of bounds
                if (index >= this.data[0][0].length) {
                    index = this.data[0][0].length - 1
                }

                if (index < 0) {
                    index = 0;
                }

                for(var x = 0 ; x < this.data.length; x++) {
                    temp_array = []
                    for(var y= 0; y < this.data[x].length; y++)
                    {
                        temp_array.push(this.data[x][y][index])
                    }
                    result.push(temp_array)
                }
                return result;
            } 
            else if(type === 'front') {
                
                result = [];

                for(var x = 0; x < this.data.length ; x++) {
                    result.push(this.data[x][index])
                }
                return result;
            }
            return []
        }

        function draw(img_array, type='RGB', flipx=false, flipy=false, alpha=1) {
            
            var ctx = this.getContext('2d');
            
            var startx = (flipx)? img_array.length - 1 : 0;
            var endx = (flipx)? 0 : img_array.length - 1;
            var stepx = (flipx)? -1 : 1;

            var starty = (flipy)? img_array[0].length - 1 : 0;
            var endy = (flipy)? 0 : img_array[0].length -1;
            var stepy = (flipy)? -1 : 1;


            var imageWidth = img_array[0].length
            var imageHeight = img_array.length
            // change the size of the canvase depending on image array
            // TODO, use scale, its better to have a static sized canvas 
            // computation would be target / size of image array = scalar
            // scalar can be used to scale

            this.height = imageHeight;
            this.width = imageWidth;

            if(type === 'grayscale') {
                for (i=startx, x=0; i != endx; i+=stepx, x++){
                    for(j=starty, y=0; j != endy;j+=stepy, y++){
                        let color = img_array[i][j]
                        ctx.fillStyle = "rgb("+color+","+color+","+color+")";
                        ctx.fillRect(y, x, 1, 1);
                    }
                }
            } 
            else if (type === 'RGB') {
                                
                for (i=startx, x=0; i != endx; i+=stepx, x++){
                    for(j=starty, y=0; j != endy;j+=stepy, y++){
                        let color = img_array[i][j]
                        if(color !== 0)
                        {
                            ctx.fillStyle = "rgba("+color['red']+","+color['green']+","+color['blue']+","+alpha+")";
                            ctx.fillRect(y, x, 1, 1);
                        }
                    }
                }
            }
        }
        
        // UTILITIES
        function postRequest(url, data={}) {
            return fetch(url, {
                body: JSON.stringify(data),
                cache: 'no-cache',
                headers: {
                    'content-type': 'application/json'
                },
                method: 'POST'
            })
        }

        main()
    </script>
</body>
</html>